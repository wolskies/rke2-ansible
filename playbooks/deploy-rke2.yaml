---
# Recommended Workflow: Core RKE2 + Rancher Deployment
# Deploy the foundation cluster and Rancher, then manage additional apps via Rancher GUI
- name: Deploy RKE2 Cluster with Rancher Management
  hosts:
    - rke2
  # Include secrets if available (not required for CI/testing)
  vars:
    secrets_file: "/home/{{ ansible_user }}/Ansible/inventory/group_vars/secrets.yaml"
  pre_tasks:
    - name: Include secrets if file exists
      ansible.builtin.include_vars: "{{ secrets_file }}"
      when: secrets_file is file
  become: false
  roles:
    # Install Helm on all nodes
    - role: helm_install
      become: false

    # Install RKE2 cluster on all nodes
    - role: deploy_rke2
      become: true

    # Install Rancher management platform (first controller only)
    - role: rancher_install
      when: inventory_hostname == (groups['controllers'] | first)
      become: false
      tags: rancher

    # Optional: Automated storage deployment (if you prefer not to use Rancher GUI)
    # Remove these roles if you want to install storage via Rancher Apps & Marketplace
    # Longhorn - distributed block storage (OPTIONAL - can install via Rancher GUI)
    # - role: longhorn_install
    #   when: inventory_hostname == (groups['controllers'] | first)
    #   become: false
    #   tags: longhorn

    # Rook/Ceph - distributed storage alternative (OPTIONAL - can install via Rancher GUI)
    # - role: rook_install
    #   when: inventory_hostname == (groups['controllers'] | first)
    #   become: false
    #   tags: rook

    # Additional optional roles (consider managing via Rancher GUI instead):
    # - role: mysql_operator
    #   when: inventory_hostname == (groups['controllers'] | first)
    #   become: false
    #   tags: mysql
